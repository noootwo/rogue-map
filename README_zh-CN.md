# RogueMap (Node.js)

RogueMap æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ã€èŠ‚çœå†…å­˜çš„ Node.js é”®å€¼å­˜å‚¨åº“ï¼Œçµæ„Ÿæ¥è‡ª [RogueMap (Java)](https://roguemap.yomahub.com/)ã€‚

## ç‰¹æ€§

- **æµ·é‡æ•°æ®æ”¯æŒ**: æ”¯æŒ **1äº¿+ æ¡æ•°æ®** ä»¥åŠ >4GB æ•°æ®é‡ï¼Œé€šè¿‡åˆ†é¡µç¼“å†² (Paged Buffers) çªç ´ Node.js Buffer é™åˆ¶ã€‚
- **å †å¤–å­˜å‚¨ (Off-Heap)**: ä½¿ç”¨å †å¤– `Buffer` å­˜å‚¨æ•°æ®ï¼Œæ˜¾è‘—é™ä½ V8 åƒåœ¾å›æ”¶ (GC) å‹åŠ›å’Œå †å†…å­˜ä½¿ç”¨ã€‚
- **é«˜æ•ˆå†…å­˜**: åœ¨å­˜å‚¨å¤§é‡æ•°æ®æ—¶ï¼Œå†…å­˜å ç”¨æ¯”åŸç”Ÿ `Map` å°‘çº¦ 50%~99%ã€‚
- **é«˜æ€§èƒ½**:
  - æå¿«çš„å†™å…¥é€Ÿåº¦ï¼ˆçº¿æ€§æ¢æµ‹ + è¿½åŠ å¼æ—¥å¿—ï¼‰ã€‚
  - é’ˆå¯¹å­—ç¬¦ä¸²ä¼˜åŒ–çš„è¯»å–æ€§èƒ½ï¼ˆç›´æ¥ç¼“å†²åŒºæ¯”è¾ƒï¼‰ã€‚
- **ç±»å‹åŒ–ç¼–è§£ç å™¨**: æ”¯æŒ String, Int32, Float64, JSON ç­‰å¤šç§æ•°æ®ç±»å‹çš„ä¼˜å­˜å‚¨ã€‚
- **é›¶ä¾èµ–**: çº¯ TypeScript/Node.js å®ç°ï¼Œæ— ç¬¬ä¸‰æ–¹è¿è¡Œæ—¶ä¾èµ–ã€‚

## å®‰è£…

```bash
npm install rogue-map
```

## ä½¿ç”¨æŒ‡å—

### åŸºç¡€ç”¨æ³•

```typescript
import { RogueMap, StringCodec, Int32Codec } from "rogue-map";

// åˆ›å»ºä¸€ä¸ªé’ˆå¯¹ String é”®å’Œ Int32 å€¼ä¼˜åŒ–çš„ Map
const map = new RogueMap<string, number>({
  capacity: 1000000, // åˆå§‹å®¹é‡ (æ¡¶æ•°é‡)
  initialMemory: 64 * 1024 * 1024, // åˆå§‹ç¼“å†²åŒºå†…å­˜ (64MB)
  keyCodec: StringCodec,
  valueCodec: Int32Codec,
});

// è®¾ç½®å€¼
map.set("user:1", 100);
map.set("user:2", 200);

// è·å–å€¼
console.log(map.get("user:1")); // 100

// æ£€æŸ¥æ˜¯å¦å­˜åœ¨
if (map.has("user:2")) {
  console.log("User 2 exists");
}

// è¿­ä»£
for (const [key, value] of map) {
  console.log(key, value);
}

// åˆ é™¤
map.delete("user:1");

// æ¸…ç©º
map.clear();

// å‹ç¼© (æ‰‹åŠ¨åƒåœ¾å›æ”¶)
map.compact();

// åºåˆ—åŒ–ä¸º Buffer
const buffer = map.serialize();
const restored = RogueMap.deserialize(buffer);

// ä¿å­˜/åŠ è½½æ–‡ä»¶ (Node.js)
import { save, load } from "rogue-map";
await save(map, "data.db");
const loadedMap = await load("data.db");
```

### é…ç½®ä¸è‡ªåŠ¨æŒä¹…åŒ–

RogueMap å¯ä»¥é€šè¿‡é…ç½®è‡ªåŠ¨ç®¡ç†æŒä¹…åŒ–å’Œå‹ç¼©ï¼š

```typescript
const map = new RogueMap<string, number>({
  // è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒ (Nodeç¯å¢ƒä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿ, æµè§ˆå™¨ç¯å¢ƒä½¿ç”¨ IndexedDB)
  persistence: {
    path: "my-db", // æ–‡ä»¶è·¯å¾„ æˆ– æ•°æ®åº“åç§°
    saveInterval: 5000, // æ¯ 5 ç§’è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡
    // syncLoad: true   // å¯åŠ¨æ—¶å°è¯•åŒæ­¥åŠ è½½ (ä»…é™ Node)
  },
  compaction: {
    autoCompact: true, // å¯ç”¨è‡ªåŠ¨å‹ç¼©
    threshold: 0.3, // å½“ 30% çš„ç©ºé—´è¢«æµªè´¹æ—¶è§¦å‘å‹ç¼©
    minSize: 1000, // è§¦å‘å‹ç¼©çš„æœ€å°æ•°æ®é‡
  },
});

// å¯¹äºå¼‚æ­¥ç¯å¢ƒ (å¦‚æµè§ˆå™¨ IndexedDB)ï¼Œè¯·ç¡®ä¿å…ˆåˆå§‹åŒ–ï¼š
await map.init();
```

## æ€§èƒ½å¯¹æ¯” (å„æ•°é‡çº§)

### 1ä¸‡ (10k Items)

| ç±»å‹         | å†™å…¥è€—æ—¶ | è¯»å–è€—æ—¶ | å †å†…å­˜ (Heap) | æ€»å†…å­˜ (RSS) |
| ------------ | -------- | -------- | ------------- | ------------ |
| **Object**   | 3ms      | 1ms      | 0.61 MB       | 0.63 MB      |
| **Map**      | 1ms      | 2ms      | 0.67 MB       | 0.47 MB      |
| **RogueMap** | 11ms     | 8ms      | **0.04 MB**   | 1.48 MB      |

### 10ä¸‡ (100k Items)

| ç±»å‹         | å†™å…¥è€—æ—¶ | è¯»å–è€—æ—¶ | å †å†…å­˜ (Heap) | æ€»å†…å­˜ (RSS) |
| ------------ | -------- | -------- | ------------- | ------------ |
| **Object**   | 37ms     | 14ms     | 8.28 MB       | 10.66 MB     |
| **Map**      | **12ms** | **2ms**  | 5.79 MB       | 5.27 MB      |
| **RogueMap** | 38ms     | 34ms     | **0.04 MB**   | 20.55 MB     |

### 100ä¸‡ (1M Items)

| ç±»å‹         | å†™å…¥è€—æ—¶  | è¯»å–è€—æ—¶ | å †å†…å­˜ (Heap) | æ€»å†…å­˜ (RSS) |
| ------------ | --------- | -------- | ------------- | ------------ |
| **Object**   | 533ms     | 278ms    | 77.75 MB      | 113.56 MB    |
| **Map**      | **300ms** | **19ms** | 57.75 MB      | 53.20 MB     |
| **RogueMap** | 472ms     | 365ms    | **0.04 MB**   | 64.75 MB     |

### 1000ä¸‡ (10M Items)

| ç±»å‹         | å†™å…¥è€—æ—¶       | è¯»å–è€—æ—¶  | å †å†…å­˜ (Heap) | æ€»å†…å­˜ (RSS) |
| ------------ | -------------- | --------- | ------------- | ------------ |
| **Object**   | âŒ (OOM/Crash) | âŒ        | -             | -            |
| **Map**      | âŒ (OOM/Crash) | âŒ        | -             | -            |
| **RogueMap** | **~4.6s**      | **~4.5s** | **0.06 MB**   | **404 MB**   |

### 1äº¿ (100M Items)

| ç±»å‹         | å†™å…¥è€—æ—¶ | è¯»å–è€—æ—¶ | å †å†…å­˜ (Heap) | æ€»å†…å­˜ (RSS) |
| ------------ | -------- | -------- | ------------- | ------------ |
| **Object**   | âŒ       | âŒ       | -             | -            |
| **Map**      | âŒ       | âŒ       | -             | -            |
| **RogueMap** | **~56s** | **~35s** | **6 MB**      | **5.44 GB**  |

> **æµ‹è¯•ç¯å¢ƒ**: macOS, Node.js v22. (å•çº¿ç¨‹)
> **ç»“è®º**:
>
> 1. **å°è§„æ¨¡ (<10ä¸‡)**: åŸç”Ÿ Map/Object æ€§èƒ½æä½³ï¼ŒRogueMap æœ‰å°‘é‡åˆå§‹å¼€é”€ã€‚
> 2. **ä¸­è§„æ¨¡ (100ä¸‡)**: RogueMap å†™å…¥æ€§èƒ½æ¥è¿‘ Objectï¼Œå †å†…å­˜å‡ ä¹ä¸ºé›¶ã€‚
> 3. **å¤§è§„æ¨¡ (>1000ä¸‡)**: **RogueMap æ˜¯å”¯ä¸€é€‰æ‹©**ã€‚åŸç”Ÿ Map/Object ä¼šå¯¼è‡´å†…å­˜æº¢å‡º (OOM) æˆ–æåº¦ç¼“æ…¢ï¼Œè€Œ RogueMap ä¾ç„¶ç¨³å®šè¿è¡Œï¼Œä¸”ä»…å ç”¨æå°‘çš„å †å†…å­˜ã€‚

## æ€§èƒ½åŸºå‡† (100ä¸‡æ•°æ®)

### åœºæ™¯ 1: å°å¯¹è±¡ (String -> Number)

> å…¸å‹çš„ "è®¡æ•°å™¨" æˆ– "ID æ˜ å°„" åœºæ™¯ã€‚

| æŒ‡æ ‡              | åŸç”Ÿ Map (V8) | RogueMap    | å·®å¼‚            |
| ----------------- | ------------- | ----------- | --------------- |
| **å†™å…¥è€—æ—¶**      | ~258ms        | **~204ms**  | **å¿« 21%** ğŸš€   |
| **è¯»å–è€—æ—¶**      | ~18ms         | ~251ms      | æ…¢ 14x (éœ€è§£ç ) |
| **å †å†…å­˜ (Heap)** | ~58 MB        | **~0.1 MB** | **å‡å°‘ 99%** ğŸ“‰ |
| **æ€»å†…å­˜ (RSS)**  | ~93 MB        | **~37 MB**  | **å‡å°‘ 61%**    |

### åœºæ™¯ 2: å¤§å¯¹è±¡ (String -> JSON)

> å­˜å‚¨å¤æ‚å¯¹è±¡ã€‚RogueMap ä¼šåºåˆ—åŒ–å®ƒä»¬ï¼ˆæ·±æ‹·è´ï¼‰ï¼Œè€ŒåŸç”Ÿ Map ä»…å­˜å‚¨å¼•ç”¨ã€‚

| æŒ‡æ ‡              | åŸç”Ÿ Map (V8) | RogueMap    | å·®å¼‚                    |
| ----------------- | ------------- | ----------- | ----------------------- |
| **å†™å…¥è€—æ—¶**      | ~261ms        | ~550ms      | æ…¢ 2x (JSON åºåˆ—åŒ–å¼€é”€) |
| **å †å†…å­˜ (Heap)** | ~104 MB       | **~0.1 MB** | **å‡å°‘ 99%**            |

> **æ ¸å¿ƒç»“è®º**: å¯¹äºæ ‡é‡æ•°æ®ï¼ˆæ•°å­—ã€çŸ­å­—ç¬¦ä¸²ï¼‰ï¼ŒRogueMap æ˜¾è‘—æ›´å¿«ä¸”æ›´è½»é‡ã€‚å¯¹äºå¤æ‚å¯¹è±¡ï¼ŒRogueMap ä»¥ CPUï¼ˆåºåˆ—åŒ–ï¼‰æ¢å–äº†å·¨å¤§çš„å†…å­˜èŠ‚çœå’Œå †å¤–å­˜å‚¨èƒ½åŠ›ã€‚

## é«˜çº§ä¼˜åŒ–

### LRU ç¼“å­˜ (çƒ­ç‚¹è¯»å–ä¼˜åŒ–)

å¯¹äºå­˜åœ¨ "çƒ­ç‚¹" key çš„å·¥ä½œè´Ÿè½½ï¼Œå¯ä»¥å¯ç”¨ä¸€ä¸ªå°çš„ LRU ç¼“å­˜æ¥ç»•è¿‡ Buffer è§£ç è¿‡ç¨‹ã€‚
è¿™ä½¿å¾—é¢‘ç¹è®¿é—®çš„æ•°æ®è¯»å–æ€§èƒ½æ¥è¿‘åŸç”Ÿ Mapã€‚

```typescript
const map = new RogueMap({
  cacheSize: 1000, // åœ¨å †å†…å­˜ä¸­ç¼“å­˜æœ€è¿‘ä½¿ç”¨çš„ 1000 ä¸ªé¡¹ç›®
});
```

| åœºæ™¯           | æ— ç¼“å­˜     | å¼€å¯ç¼“å­˜ (çƒ­æ•°æ®) |
| -------------- | ---------- | ----------------- |
| **çƒ­ç‚¹è¯»å–**   | ~158ms     | **~122ms**        |
| **å†·æ•°æ®æ‰«æ** | **~270ms** | ~800ms            |

> **æ³¨æ„**: å¯ç”¨ç¼“å­˜ä¼šå¢åŠ å†·æ•°æ®æ‰«æçš„å¼€é”€ï¼ˆå› ä¸ºéœ€è¦æ›´æ–°ç¼“å­˜ï¼‰ï¼Œä½†èƒ½æ˜¾è‘—åŠ é€Ÿé‡å¤è®¿é—®ã€‚ä»…åœ¨å…·æœ‰æ•°æ®å±€éƒ¨æ€§æ—¶ä½¿ç”¨ã€‚

## API æ–‡æ¡£

### `new RogueMap(options)`

- `capacity`: å“ˆå¸Œæ¡¶çš„åˆå§‹æ•°é‡ (é»˜è®¤: 16384)ã€‚
- `initialMemory`: æ•°æ®ç¼“å†²åŒºçš„åˆå§‹å¤§å°ï¼Œå•ä½å­—èŠ‚ (é»˜è®¤: 10MB)ã€‚
- `keyCodec`: é”®çš„ç¼–è§£ç å™¨ (é»˜è®¤: `AnyCodec`)ã€‚
- `valueCodec`: å€¼çš„ç¼–è§£ç å™¨ (é»˜è®¤: `AnyCodec`)ã€‚
- `hasher`: è‡ªå®šä¹‰å“ˆå¸Œå‡½æ•°ã€‚

### ç¼–è§£ç å™¨ (Codecs)

RogueMap æ”¯æŒé«˜æ•ˆçš„ç±»å‹åŒ–å­˜å‚¨ã€‚ä½¿ç”¨ç‰¹å®šçš„ç¼–è§£ç å™¨å¯ä»¥è·å¾—æœ€ä½³æ€§èƒ½å’Œæœ€å°å†…å­˜å ç”¨ï¼Œæˆ–è€…ä½¿ç”¨ `AnyCodec` ä»¥è·å¾—æœ€å¤§çš„çµæ´»æ€§ã€‚

- `StringCodec` (å­—ç¬¦ä¸²ï¼Œå˜é•¿)
- `JSONCodec` (JSON å¯¹è±¡ï¼Œå˜é•¿)
- `Int32Codec` (32ä½æ•´æ•°, 4 å­—èŠ‚)
- `Float64Codec` (åŒç²¾åº¦æµ®ç‚¹æ•°, 8 å­—èŠ‚)
- `BooleanCodec` (å¸ƒå°”å€¼, 1 å­—èŠ‚)
- `BigInt64Codec` (64ä½å¤§æ•´æ•°, 8 å­—èŠ‚)
- `DateCodec` (æ—¥æœŸ, 8 å­—èŠ‚æ—¶é—´æˆ³)
- `BufferCodec` (äºŒè¿›åˆ¶ Buffer, å˜é•¿)
- `AnyCodec` (é»˜è®¤ï¼Œè‡ªåŠ¨æ£€æµ‹ç±»å‹å¹¶æ·»åŠ ç±»å‹æ ‡ç­¾å‰ç¼€)

```typescript
import { RogueMap, BooleanCodec, DateCodec } from "rogue-map";

const map = new RogueMap<string, Date>({
  valueCodec: DateCodec,
});

map.set("created_at", new Date());
```

## æ¶æ„

RogueMap ä½¿ç”¨åŸºäº **åˆ†é¡µç¼“å†² (Paged Buffer)** ç³»ç»Ÿçš„ **çº¿æ€§æ¢æµ‹å“ˆå¸Œè¡¨ (Linear Probing Hash Table)**ã€‚

- **Buckets**: `Float64Array`ï¼Œå­˜å‚¨ 64 ä½åç§»é‡ï¼Œæ”¯æŒ >4GB åœ°å€ç©ºé—´ã€‚
- **Paged Buffer**: å¤šé‡ Node.js Buffer å°è£… (é»˜è®¤ 1GB åˆ†é¡µ)ï¼Œçªç ´ 2GB/4GB å•ä¸ª Buffer é™åˆ¶ã€‚
- **Data Buffer**: é¡ºåºå­˜å‚¨æ¡ç›® `[Flag][KeyLen][ValLen][Key][Value]`ã€‚
- **Resizing**: å½“è´Ÿè½½å› å­è¾¾åˆ° 0.75 æˆ– Buffer æ»¡æ—¶ï¼Œè‡ªåŠ¨å°†å®¹é‡å’Œ Buffer å¤§å°ç¿»å€ã€‚

## License

MIT
